<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Practice Game</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body id="gameBody" class="theme-purple">
    <div class="container">
        <!-- Start Screen -->
        <div id="startScreen" class="screen active">
            <h1 id="gameTitle">üéÆ Loading...</h1>
            <p class="subtitle" id="gameSubtitle">Practice Game</p>
            
            <div class="instruction" id="gameOverview">
                üéØ Choose your practice mode:
            </div>

            <div class="selector-grid" id="modesGrid">
                <!-- Modes will be loaded dynamically -->
            </div>

            <div class="button-group">
                <button class="btn-secondary" onclick="backToMainMenu()">‚Üê Back to Main Menu</button>
            </div>
        </div>

        <!-- Difficulty Selection Screen -->
        <div id="difficultyScreen" class="screen">
            <h1 id="gameTitleDifficulty">üéÆ Game</h1>
            <p class="subtitle" id="modeTitle">Mode</p>
            
            <div class="instruction" id="modeInstruction">
                üìù Choose a difficulty level
            </div>

            <div class="selector-grid" id="difficultiesGrid">
                <!-- Difficulties will be loaded dynamically -->
            </div>

            <div class="button-group">
                <button class="btn-secondary" onclick="backToStart()">‚Üê Back to Modes</button>
                <button class="btn-secondary" onclick="backToMainMenu()">‚Üê Main Menu</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="screen">
            <h1 id="gameTitlePlay">üéÆ Game</h1>
            
            <div class="score-board">
                <div class="score-item">
                    <div class="score-label">Correct</div>
                    <div class="score-value" id="correctScore">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">Incorrect</div>
                    <div class="score-value incorrect" id="incorrectScore">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">Total</div>
                    <div class="score-value total" id="totalScore">0</div>
                </div>
            </div>

            <div class="instruction" id="gameInstruction">
                Practice and press Enter.
            </div>

            <div class="challenge-display" id="challengeDisplay">-</div>

            <!-- Speaking Mode Controls -->
            <div id="speakingControls" class="input-group" style="display: none;">
                <button id="startSpeaking" onclick="startSpeechRecognition()" class="speech-button">üé§ Start Speaking</button>
                <button id="playAudio" onclick="playAudio()" class="speech-button">üîä Repeat</button>
            </div>

            <!-- Listening Mode Controls -->
            <div id="listeningControls" class="input-group" style="display: none;">
                <button id="playListening" onclick="playAudio()" class="speech-button">üîä Play</button>
                <div style="margin-top: 15px;">
                    <input 
                        type="text" 
                        id="listeningInput" 
                        placeholder="Type what you heard..." 
                        autocomplete="off"
                        onkeypress="handleKeyPress(event)"
                    >
                </div>
            </div>

            <!-- Writing Mode Controls -->
            <div id="writingControls" class="input-group">
                <input 
                    type="text" 
                    id="answerInput" 
                    placeholder="Type your answer..." 
                    autocomplete="off"
                    onkeypress="handleKeyPress(event)"
                >
            </div>

            <div id="feedback" class="feedback hidden"></div>

            <div class="button-group">
                <button class="btn-primary" id="checkBtn" onclick="checkAnswer()">‚úì Check Answer</button>
                <button class="btn-primary" id="nextBtn" onclick="generateNewChallenge()" style="display: none;">‚Üí Next</button>
                <button class="btn-secondary" onclick="backToDifficulty()">‚Üê Back to Difficulty</button>
                <button class="btn-secondary" onclick="backToMainMenu()">‚Üê Main Menu</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // GAME CONFIGURATION (LOADED FROM JSON)
        // ============================================
        let gameConfig = null;
        let configLoaded = false;
        let converterFunctions = {};

        // ============================================
        // GAME STATE
        // ============================================
        let currentValue = 0;
        let minRange = 1;
        let maxRange = 20;
        let correctCount = 0;
        let incorrectCount = 0;
        let totalCount = 0;
        let currentAnswer = '';
        let gameMode = 'writing';
        let speechSynthesis = window.speechSynthesis;
        let recognition = null;

        // ============================================
        // LOAD GAME CONFIGURATION
        // ============================================
        async function loadGameConfig() {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('game');
            
            if (!gameId) {
                alert('No game specified!');
                window.location.href = '../index.html';
                return;
            }

            try {
                const response = await fetch(`../games/${gameId}.json`);
                if (!response.ok) {
                    throw new Error('Failed to load game configuration');
                }
                gameConfig = await response.json();
                configLoaded = true;
                
                // Load converter functions if specified
                if (gameConfig.converterScript) {
                    await loadConverterScript(gameConfig.converterScript);
                }
                
                applyGameConfig();
            } catch (error) {
                console.error('Error loading game configuration:', error);
                alert('Error loading game. Please return to main menu.');
                window.location.href = '../index.html';
            }
        }

        async function loadConverterScript(scriptPath) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = scriptPath;
                script.onload = () => {
                    if (window.gameConverters) {
                        converterFunctions = window.gameConverters;
                    }
                    resolve();
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // ============================================
        // APPLY CONFIGURATION TO UI
        // ============================================
        function applyGameConfig() {
            document.getElementById('pageTitle').textContent = `${gameConfig.title} - English Practice`;
            document.getElementById('gameTitle').textContent = `${gameConfig.icon} ${gameConfig.title}`;
            document.getElementById('gameTitleDifficulty').textContent = `${gameConfig.icon} ${gameConfig.title}`;
            document.getElementById('gameTitlePlay').textContent = `${gameConfig.icon} ${gameConfig.title}`;
            document.getElementById('gameSubtitle').textContent = gameConfig.subtitle;
            document.getElementById('gameOverview').innerHTML = gameConfig.overview;
            document.getElementById('gameBody').className = gameConfig.theme;

            const modesGrid = document.getElementById('modesGrid');
            modesGrid.innerHTML = '';
            
            gameConfig.modes.forEach(mode => {
                const modeDiv = document.createElement('div');
                modeDiv.className = 'selector-option';
                modeDiv.onclick = () => showModeScreen(mode.id);
                modeDiv.innerHTML = `
                    <h3>${mode.icon} ${mode.name}</h3>
                    <p>${mode.description}</p>
                `;
                modesGrid.appendChild(modeDiv);
            });
        }

        // ============================================
        // VALUE CONVERSION AND DISPLAY
        // ============================================
        function convertValue(value) {
            if (converterFunctions.convertToAnswer) {
                return converterFunctions.convertToAnswer(value, gameConfig);
            }
            return value.toString();
        }

        function displayValue(value) {
            if (converterFunctions.displayValue) {
                return converterFunctions.displayValue(value, gameConfig);
            }
            return value.toString();
        }

        // ============================================
        // RANDOM VALUE GENERATION
        // ============================================
        function getRandomValue(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function getSmartRandomValue(min, max) {
            if (converterFunctions.getSmartRandom) {
                return converterFunctions.getSmartRandom(min, max);
            }
            
            if (max <= 100) {
                return getRandomValue(min, max);
            }
            
            const rand = Math.random();
            
            if (max <= 999999) {
                if (rand < 0.15) return getRandomValue(1, Math.min(99, max));
                else if (rand < 0.35) return getRandomValue(100, Math.min(999, max));
                else if (rand < 0.70) return getRandomValue(1000, Math.min(99999, max));
                else return getRandomValue(100000, max);
            } else {
                if (rand < 0.10) return getRandomValue(1, 99);
                else if (rand < 0.15) return getRandomValue(100, 999);
                else if (rand < 0.30) return getRandomValue(1000, 99999);
                else if (rand < 0.60) return getRandomValue(100000, 999999);
                else if (rand < 0.85) return getRandomValue(1000000, 99999999);
                else return getRandomValue(100000000, max);
            }
        }

        // ============================================
        // GAME FLOW
        // ============================================
        function startGame(min, max) {
            minRange = min;
            maxRange = max;
            correctCount = 0;
            incorrectCount = 0;
            totalCount = 0;
            
            updateScores();
            showScreen('gameScreen');
            setupGameMode();
            generateNewChallenge();
        }

        function generateNewChallenge() {
            currentValue = getSmartRandomValue(minRange, maxRange);
            currentAnswer = convertValue(currentValue);
            document.getElementById('challengeDisplay').textContent = displayValue(currentValue);
            
            if (gameMode === 'writing') {
                document.getElementById('answerInput').value = '';
                document.getElementById('answerInput').focus();
            } else if (gameMode === 'listening') {
                document.getElementById('listeningInput').value = '';
                document.getElementById('listeningInput').focus();
            }
            
            hideFeedback();
        }

        function normalizeAnswer(text) {
            if (converterFunctions.normalizeAnswer) {
                return converterFunctions.normalizeAnswer(text);
            }
            
            return text.toLowerCase()
                .trim()
                .replace(/\s+/g, ' ')
                .replace(/,/g, '')
                .replace(/\band\b/g, 'and')
                .replace(/\bone hundred\b/g, 'a hundred')
                .replace(/\bone thousand\b/g, 'a thousand')
                .replace(/\bone million\b/g, 'a million')
                .replace(/\bone hundredth\b/g, 'a hundredth')
                .replace(/\bone thousandth\b/g, 'a thousandth')
                .replace(/\bone millionth\b/g, 'a millionth')
                .replace(/\bone hundred and\b/g, 'a hundred and');
        }

        function getAcceptedAnswers(correctAnswer) {
            if (converterFunctions.getAcceptedAnswers) {
                return converterFunctions.getAcceptedAnswers(correctAnswer, currentValue, gameMode, gameConfig);
            }
            
            const normalizedCorrect = normalizeAnswer(correctAnswer);
            const acceptedAnswers = [normalizedCorrect];
            
            const oneVariant = normalizedCorrect
                .replace(/\ba hundred\b/g, 'one hundred')
                .replace(/\ba thousand\b/g, 'one thousand')
                .replace(/\ba million\b/g, 'one million')
                .replace(/\ba hundredth\b/g, 'one hundredth')
                .replace(/\ba thousandth\b/g, 'one thousandth')
                .replace(/\ba millionth\b/g, 'one millionth')
                .replace(/\ba hundred and\b/g, 'one hundred and');
            
            if (oneVariant !== normalizedCorrect) {
                acceptedAnswers.push(oneVariant);
            }
            
            if (gameMode === 'listening') {
                acceptedAnswers.push(displayValue(currentValue).toLowerCase());
            }
            
            return acceptedAnswers;
        }

        function checkAnswer() {
            let userAnswer = '';
            
            if (gameMode === 'writing') {
                userAnswer = document.getElementById('answerInput').value;
            } else if (gameMode === 'listening') {
                userAnswer = document.getElementById('listeningInput').value;
            } else {
                return;
            }
            
            const normalizedUser = normalizeAnswer(userAnswer);
            const acceptedAnswers = getAcceptedAnswers(currentAnswer);
            
            const feedbackElement = document.getElementById('feedback');
            
            if (acceptedAnswers.includes(normalizedUser)) {
                correctCount++;
                totalCount++;
                feedbackElement.textContent = '‚úì Correct! Well done!';
                feedbackElement.className = 'feedback correct';
                
                updateScores();
                
                setTimeout(() => {
                    generateNewChallenge();
                }, 600);
            } else {
                incorrectCount++;
                totalCount++;
                
                let correctDisplay = acceptedAnswers.length > 1 
                    ? `"${acceptedAnswers[0]}" or "${acceptedAnswers[1]}"` 
                    : `"${acceptedAnswers[0]}"`;
                
                if (gameMode === 'listening' && acceptedAnswers.length > 2) {
                    correctDisplay += ` or "${acceptedAnswers[2]}"`;
                }
                    
                feedbackElement.textContent = `‚úó Incorrect. The correct answer is: ${correctDisplay}. Try again!`;
                feedbackElement.className = 'feedback incorrect';
                
                updateScores();
                
                setTimeout(() => {
                    if (gameMode === 'writing') {
                        document.getElementById('answerInput').value = '';
                        document.getElementById('answerInput').focus();
                    } else if (gameMode === 'listening') {
                        document.getElementById('listeningInput').value = '';
                        document.getElementById('listeningInput').focus();
                    }
                    hideFeedback();
                }, 2000);
            }
        }

        function updateScores() {
            document.getElementById('correctScore').textContent = correctCount;
            document.getElementById('incorrectScore').textContent = incorrectCount;
            document.getElementById('totalScore').textContent = totalCount;
        }

        function hideFeedback() {
            document.getElementById('feedback').className = 'feedback hidden';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                checkAnswer();
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showModeScreen(modeId) {
            gameMode = modeId;
            const mode = gameConfig.modes.find(m => m.id === modeId);
            
            document.getElementById('modeTitle').textContent = mode.name;
            document.getElementById('modeInstruction').innerHTML = mode.instruction;
            
            const difficultiesGrid = document.getElementById('difficultiesGrid');
            difficultiesGrid.innerHTML = '';
            
            gameConfig.difficulties.forEach(diff => {
                const diffDiv = document.createElement('div');
                diffDiv.className = 'selector-option';
                diffDiv.onclick = () => startGame(diff.min, diff.max);
                diffDiv.innerHTML = `
                    <h3>${diff.icon} ${diff.name}</h3>
                    <p>${diff.description}</p>
                `;
                difficultiesGrid.appendChild(diffDiv);
            });
            
            showScreen('difficultyScreen');
        }

        function setupGameMode() {
            const writingControls = document.getElementById('writingControls');
            const speakingControls = document.getElementById('speakingControls');
            const listeningControls = document.getElementById('listeningControls');
            const challengeDisplay = document.getElementById('challengeDisplay');
            const gameInstruction = document.getElementById('gameInstruction');
            const checkBtn = document.getElementById('checkBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            writingControls.style.display = 'none';
            speakingControls.style.display = 'none';
            listeningControls.style.display = 'none';
            
            const mode = gameConfig.modes.find(m => m.id === gameMode);
            
            switch(gameMode) {
                case 'writing':
                    writingControls.style.display = 'block';
                    challengeDisplay.style.display = 'block';
                    gameInstruction.innerHTML = mode.gameInstruction;
                    checkBtn.style.display = 'inline-block';
                    nextBtn.style.display = 'none';
                    break;
                    
                case 'speaking':
                    speakingControls.style.display = 'block';
                    challengeDisplay.style.display = 'block';
                    gameInstruction.innerHTML = mode.gameInstruction;
                    checkBtn.style.display = 'none';
                    nextBtn.style.display = 'inline-block';
                    setupSpeechRecognition();
                    break;
                    
                case 'listening':
                    listeningControls.style.display = 'block';
                    challengeDisplay.style.display = 'none';
                    gameInstruction.innerHTML = mode.gameInstruction;
                    checkBtn.style.display = 'inline-block';
                    nextBtn.style.display = 'none';
                    break;
            }
        }

        function setupSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onresult = function(event) {
                    const spoken = event.results[0][0].transcript.toLowerCase().trim();
                    checkSpokenAnswer(spoken);
                };
                
                recognition.onerror = function(event) {
                    document.getElementById('feedback').textContent = 'Speech recognition error. Please try again.';
                    document.getElementById('feedback').className = 'feedback incorrect';
                    document.getElementById('startSpeaking').classList.remove('recording');
                };
                
                recognition.onend = function() {
                    document.getElementById('startSpeaking').classList.remove('recording');
                };
            }
        }

        function startSpeechRecognition() {
            if (recognition) {
                document.getElementById('startSpeaking').classList.add('recording');
                recognition.start();
            } else {
                alert('Speech recognition is not supported in your browser.');
            }
        }

        function playAudio() {
            if (speechSynthesis) {
                const utterance = new SpeechSynthesisUtterance(currentAnswer);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                speechSynthesis.speak(utterance);
            } else {
                alert('Speech synthesis is not supported in your browser.');
            }
        }

        function checkSpokenAnswer(spoken) {
            const normalizedSpoken = normalizeAnswer(spoken);
            const acceptedAnswers = getAcceptedAnswers(currentAnswer);
            
            const feedbackElement = document.getElementById('feedback');
            
            if (acceptedAnswers.includes(normalizedSpoken)) {
                correctCount++;
                totalCount++;
                feedbackElement.textContent = '‚úì Correct! Well done!';
                feedbackElement.className = 'feedback correct';
                updateScores();
                
                setTimeout(() => {
                    generateNewChallenge();
                }, 1000);
            } else {
                incorrectCount++;
                totalCount++;
                const correctDisplay = acceptedAnswers.length > 1 
                    ? `"${acceptedAnswers[0]}" or "${acceptedAnswers[1]}"` 
                    : `"${acceptedAnswers[0]}"`;
                feedbackElement.textContent = `‚úó You said: "${spoken}". Correct: ${correctDisplay}`;
                feedbackElement.className = 'feedback incorrect';
                updateScores();
            }
        }

        function backToStart() {
            showScreen('startScreen');
        }

        function backToDifficulty() {
            showScreen('difficultyScreen');
        }

        function backToMainMenu() {
            window.location.href = '../index.html';
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        window.addEventListener('DOMContentLoaded', () => {
            loadGameConfig();
        });
    </script>
</body>
</html>
