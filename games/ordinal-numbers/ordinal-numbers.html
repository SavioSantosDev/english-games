<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordinal Numbers Game - English Practice</title>
    <link rel="stylesheet" href="../../css/styles.css">
</head>
<body class="theme-orange">
    <div class="container">
        <!-- Tela Inicial -->
        <div id="startScreen" class="screen active">
            <h1>ğŸ† Ordinal Numbers</h1>
            <p class="subtitle">Practice English Ordinal Numbers</p>
            
            <div class="instruction">
                ğŸ¯ Choose your practice mode:
            </div>

            <div class="selector-grid">
                <div class="selector-option" onclick="showModeScreen('writing')">
                    <h3>âœï¸ Writing Mode</h3>
                    <p>See ordinal numbers and write them in English</p>
                </div>
                
                <div class="selector-option" onclick="showModeScreen('speaking')">
                    <h3>ğŸ—£ï¸ Speaking Mode</h3>
                    <p>See ordinal numbers and speak them aloud</p>
                </div>
                
                <div class="selector-option" onclick="showModeScreen('listening')">
                    <h3>ğŸ‘‚ Listening Mode</h3>
                    <p>Listen to ordinal numbers and write what you hear</p>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-secondary" onclick="backToMainMenu()">â† Back to Main Menu</button>
            </div>
        </div>

        <!-- Tela de SeleÃ§Ã£o de Dificuldade -->
        <div id="difficultyScreen" class="screen">
            <h1>ğŸ† Ordinal Numbers</h1>
            <p class="subtitle" id="modeTitle">Writing Mode</p>
            
            <div class="instruction" id="modeInstruction">
                ï¿½ğŸ“ Choose a number range and write the ordinal numbers in English!<br>
                Examples: 1st â†’ first, 2nd â†’ second, 3rd â†’ third, 4th â†’ fourth
            </div>

            <div class="selector-grid">
                <div class="selector-option" onclick="startGame(1, 20)">
                    <h3>ğŸŸ¢ Easy</h3>
                    <p>Ordinal numbers from 1st to 20th</p>
                </div>
                
                <div class="selector-option" onclick="startGame(1, 100)">
                    <h3>ğŸŸ¡ Medium</h3>
                    <p>Ordinal numbers from 1st to 100th</p>
                </div>
                
                <div class="selector-option" onclick="startGame(1, 999999)">
                    <h3>ğŸ”´ Hard</h3>
                    <p>Ordinal numbers from 1st to 999,999th</p>
                </div>
                
                <div class="selector-option" onclick="startGame(1, 999999999)">
                    <h3>ğŸ”¥ Expert</h3>
                    <p>Ordinal numbers from 1st to 999,999,999th</p>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-secondary" onclick="backToStart()">â† Back to Modes</button>
                <button class="btn-secondary" onclick="backToMainMenu()">â† Main Menu</button>
            </div>
        </div>

        <!-- Tela do Jogo -->
        <div id="gameScreen" class="screen">
            <h1>ğŸ† Ordinal Numbers</h1>
            
            <div class="score-board">
                <div class="score-item">
                    <div class="score-label">Correct</div>
                    <div class="score-value" id="correctScore">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">Incorrect</div>
                    <div class="score-value incorrect" id="incorrectScore">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">Total</div>
                    <div class="score-value total" id="totalScore">0</div>
                </div>
            </div>

            <div class="instruction" id="gameInstruction">
                Write the ordinal number below in English and press Enter.<br>
                <small style="opacity: 0.8;">Keep trying until you get it right!</small>
            </div>

            <div class="number-display" id="numberDisplay">1st</div>

            <!-- Speaking Mode Controls -->
            <div id="speakingControls" class="input-group" style="display: none;">
                <button id="startSpeaking" onclick="startSpeechRecognition()" class="speech-button">ğŸ¤ Start Speaking</button>
                <button id="playAudio" onclick="playNumberAudio()" class="speech-button">ğŸ”Š Repeat Number</button>
            </div>

            <!-- Listening Mode Controls -->
            <div id="listeningControls" class="input-group" style="display: none;">
                <button id="playListening" onclick="playNumberAudio()" class="speech-button">ğŸ”Š Play Number</button>
                <div style="margin-top: 15px;">
                    <input 
                        type="text" 
                        id="listeningInput" 
                        placeholder="Type what you heard..." 
                        autocomplete="off"
                        onkeypress="handleKeyPress(event)"
                    >
                </div>
            </div>

            <!-- Writing Mode Controls (existing) -->
            <div id="writingControls" class="input-group">
                <input 
                    type="text" 
                    id="answerInput" 
                    placeholder="Type the ordinal number in English..." 
                    autocomplete="off"
                    onkeypress="handleKeyPress(event)"
                >
            </div>

            <div id="feedback" class="feedback hidden"></div>

            <div class="button-group">
                <button class="btn-primary" id="checkBtn" onclick="checkAnswer()">âœ“ Check Answer</button>
                <button class="btn-primary" id="nextBtn" onclick="generateNewNumber()" style="display: none;">â†’ Next Number</button>
                <button class="btn-secondary" onclick="backToDifficulty()">â† Back to Difficulty</button>
                <button class="btn-secondary" onclick="backToMainMenu()">â† Main Menu</button>
            </div>
        </div>
    </div>

    <script>
        let currentNumber = 0;
        let minRange = 1;
        let maxRange = 20;
        let correctCount = 0;
        let incorrectCount = 0;
        let totalCount = 0;
        let currentAnswer = '';
        let gameMode = 'writing'; // 'writing', 'speaking', 'listening'
        let speechSynthesis = window.speechSynthesis;
        let recognition = null;

        function numberToOrdinal(num) {
            const ones = ['', 'first', 'second', 'third', 'fourth', 'fifth', 'sixth', 'seventh', 'eighth', 'ninth'];
            const teens = ['tenth', 'eleventh', 'twelfth', 'thirteenth', 'fourteenth', 'fifteenth', 
                          'sixteenth', 'seventeenth', 'eighteenth', 'nineteenth'];
            const tens = ['', '', 'twentieth', 'thirtieth', 'fortieth', 'fiftieth', 
                         'sixtieth', 'seventieth', 'eightieth', 'ninetieth'];
            
            if (num === 0) return 'zeroth';
            
            if (num < 10) return ones[num];
            if (num < 20) return teens[num - 10];
            if (num < 100) {
                if (num % 10 === 0) {
                    return tens[Math.floor(num / 10)];
                } else {
                    const tensPlace = Math.floor(num / 10);
                    const onesPlace = num % 10;
                    return tens[tensPlace].replace('ieth', 'y-') + ones[onesPlace];
                }
            }
            if (num < 1000) {
                const hundreds = Math.floor(num / 100);
                const remainder = num % 100;
                const hundredText = hundreds === 1 ? 'a hundred' : ones[hundreds] + ' hundred';
                if (remainder === 0) {
                    return hundredText + 'th';
                } else {
                    return hundredText + ' and ' + numberToOrdinal(remainder);
                }
            }
            if (num < 1000000) {
                const thousands = Math.floor(num / 1000);
                const remainder = num % 1000;
                const thousandText = thousands === 1 ? 'a thousand' : numberToWords(thousands) + ' thousand';
                
                if (remainder === 0) {
                    return thousandText + 'th';
                } else {
                    return thousandText + ' ' + numberToOrdinal(remainder);
                }
            }
            if (num < 1000000000) {
                const millions = Math.floor(num / 1000000);
                const remainder = num % 1000000;
                const millionText = millions === 1 ? 'a million' : numberToWords(millions) + ' million';
                
                if (remainder === 0) {
                    return millionText + 'th';
                } else {
                    return millionText + ' ' + numberToOrdinal(remainder);
                }
            }
            
            return num.toString() + 'th';
        }

        function numberToWords(num) {
            const ones = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
            const teens = ['ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];
            const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
            
            if (num === 0) return 'zero';
            
            if (num < 10) return ones[num];
            if (num < 20) return teens[num - 10];
            if (num < 100) {
                return tens[Math.floor(num / 10)] + (num % 10 !== 0 ? '-' + ones[num % 10] : '');
            }
            if (num < 1000) {
                const hundreds = Math.floor(num / 100);
                const remainder = num % 100;
                const hundredText = hundreds === 1 ? 'a hundred' : ones[hundreds] + ' hundred';
                return hundredText + (remainder !== 0 ? ' and ' + numberToWords(remainder) : '');
            }
            if (num < 1000000) {
                const thousands = Math.floor(num / 1000);
                const remainder = num % 1000;
                const thousandText = thousands === 1 ? 'a thousand' : numberToWords(thousands) + ' thousand';
                return thousandText + (remainder !== 0 ? ' ' + numberToWords(remainder) : '');
            }
            if (num < 1000000000) {
                const millions = Math.floor(num / 1000000);
                const remainder = num % 1000000;
                const millionText = millions === 1 ? 'a million' : numberToWords(millions) + ' million';
                return millionText + (remainder !== 0 ? ' ' + numberToWords(remainder) : '');
            }
            
            return num.toString();
        }

        function numberToOrdinalSuffix(num) {
            const lastTwoDigits = num % 100;
            const lastDigit = num % 10;
            
            const formattedNum = num.toLocaleString();
            
            if (lastTwoDigits >= 11 && lastTwoDigits <= 13) {
                return formattedNum + 'th';
            }
            
            switch (lastDigit) {
                case 1: return formattedNum + 'st';
                case 2: return formattedNum + 'nd';
                case 3: return formattedNum + 'rd';
                default: return formattedNum + 'th';
            }
        }

        function getRandomNumber(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function getSmartRandomNumber(min, max) {
            // Para ranges pequenos, usar distribuiÃ§Ã£o normal
            if (max <= 100) {
                return getRandomNumber(min, max);
            }
            
            // Para ranges maiores, usar distribuiÃ§Ã£o ponderada
            const rand = Math.random();
            
            if (max <= 999999) { // Hard mode
                if (rand < 0.15) {
                    // 15% - Unidades e dezenas (1-99)
                    return getRandomNumber(1, Math.min(99, max));
                } else if (rand < 0.35) {
                    // 20% - Centenas (100-999)
                    return getRandomNumber(100, Math.min(999, max));
                } else if (rand < 0.70) {
                    // 35% - Milhares (1000-99999)
                    return getRandomNumber(1000, Math.min(99999, max));
                } else {
                    // 30% - Dezenas/centenas de milhares (100000-999999)
                    return getRandomNumber(100000, max);
                }
            } else { // Expert mode
                if (rand < 0.10) {
                    // 10% - Unidades e dezenas (1-99)
                    return getRandomNumber(1, 99);
                } else if (rand < 0.15) {
                    // 5% - Centenas (100-999)
                    return getRandomNumber(100, 999);
                } else if (rand < 0.30) {
                    // 15% - Milhares (1000-99999)
                    return getRandomNumber(1000, 99999);
                } else if (rand < 0.60) {
                    // 30% - Centenas de milhares (100000-999999)
                    return getRandomNumber(100000, 999999);
                } else if (rand < 0.85) {
                    // 25% - MilhÃµes (1000000-99999999)
                    return getRandomNumber(1000000, 99999999);
                } else {
                    // 15% - Centenas de milhÃµes (100000000-999999999)
                    return getRandomNumber(100000000, max);
                }
            }
        }

        function startGame(min, max) {
            minRange = min;
            maxRange = max;
            correctCount = 0;
            incorrectCount = 0;
            totalCount = 0;
            
            updateScores();
            showScreen('gameScreen');
            setupGameMode();
            generateNewNumber();
        }

        function generateNewNumber() {
            currentNumber = getSmartRandomNumber(minRange, maxRange);
            currentAnswer = numberToOrdinal(currentNumber);
            document.getElementById('numberDisplay').textContent = numberToOrdinalSuffix(currentNumber);
            
            // Clear inputs based on mode
            if (gameMode === 'writing') {
                document.getElementById('answerInput').value = '';
                document.getElementById('answerInput').focus();
            } else if (gameMode === 'listening') {
                document.getElementById('listeningInput').value = '';
                document.getElementById('listeningInput').focus();
            }
            
            hideFeedback();
        }

        function normalizeAnswer(text) {
            return text.toLowerCase()
                .trim()
                .replace(/\s+/g, ' ')
                .replace(/,/g, '')
                .replace(/\band\b/g, 'and')
                .replace(/-/g, '-')
                // Normalizar variaÃ§Ãµes de "a" vs "one"
                .replace(/\bone hundredth\b/g, 'a hundredth')
                .replace(/\bone thousandth\b/g, 'a thousandth')
                .replace(/\bone millionth\b/g, 'a millionth')
                .replace(/\bone hundred and\b/g, 'a hundred and')
                .replace(/\bone thousand\b/g, 'a thousand')
                .replace(/\bone million\b/g, 'a million');
        }

        function checkAnswer() {
            let userAnswer = '';
            
            if (gameMode === 'writing') {
                userAnswer = document.getElementById('answerInput').value;
            } else if (gameMode === 'listening') {
                userAnswer = document.getElementById('listeningInput').value;
            } else {
                return; // Speaking mode doesn't use this function
            }
            
            const normalizedUser = normalizeAnswer(userAnswer);
            const normalizedCorrect = normalizeAnswer(currentAnswer);
            
            // Criar variaÃ§Ãµes aceitas da resposta correta
            const acceptedAnswers = [normalizedCorrect];
            
            // Adicionar variaÃ§Ãµes com "one" em vez de "a"
            const oneVariant = normalizedCorrect
                .replace(/\ba hundredth\b/g, 'one hundredth')
                .replace(/\ba thousandth\b/g, 'one thousandth')
                .replace(/\ba millionth\b/g, 'one millionth')
                .replace(/\ba hundred and\b/g, 'one hundred and')
                .replace(/\ba thousand\b/g, 'one thousand')
                .replace(/\ba million\b/g, 'one million');
            
            if (oneVariant !== normalizedCorrect) {
                acceptedAnswers.push(oneVariant);
            }
            
            // For listening mode, also accept the numeric ordinal form
            if (gameMode === 'listening') {
                const numericOrdinal = numberToOrdinalSuffix(currentNumber);
                acceptedAnswers.push(numericOrdinal.toLowerCase());
            }
            
            const feedbackElement = document.getElementById('feedback');
            
            if (acceptedAnswers.includes(normalizedUser) || (gameMode === 'listening' && userAnswer.trim().toLowerCase() === numberToOrdinalSuffix(currentNumber).toLowerCase())) {
                correctCount++;
                totalCount++;
                feedbackElement.textContent = 'âœ“ Correct! Well done!';
                feedbackElement.className = 'feedback correct';
                
                updateScores();
                
                setTimeout(() => {
                    generateNewNumber();
                }, 600);
            } else {
                incorrectCount++;
                totalCount++;
                
                // Mostrar ambas as variaÃ§Ãµes aceitas se existirem
                let correctDisplay = acceptedAnswers.length > 1 
                    ? `"${acceptedAnswers[0]}" or "${acceptedAnswers[1]}"` 
                    : `"${acceptedAnswers[0]}"`;
                
                // Add numeric ordinal option for listening mode
                if (gameMode === 'listening') {
                    correctDisplay += ` or "${numberToOrdinalSuffix(currentNumber)}"`;
                }
                    
                feedbackElement.textContent = `âœ— Incorrect. The correct answer is: ${correctDisplay}. Try again!`;
                feedbackElement.className = 'feedback incorrect';
                
                updateScores();
                
                // Limpar o campo e manter o mesmo nÃºmero para nova tentativa
                setTimeout(() => {
                    if (gameMode === 'writing') {
                        document.getElementById('answerInput').value = '';
                        document.getElementById('answerInput').focus();
                    } else if (gameMode === 'listening') {
                        document.getElementById('listeningInput').value = '';
                        document.getElementById('listeningInput').focus();
                    }
                    hideFeedback();
                }, 2000);
            }
        }

        function updateScores() {
            document.getElementById('correctScore').textContent = correctCount;
            document.getElementById('incorrectScore').textContent = incorrectCount;
            document.getElementById('totalScore').textContent = totalCount;
        }

        function hideFeedback() {
            document.getElementById('feedback').className = 'feedback hidden';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                checkAnswer();
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showModeScreen(mode) {
            gameMode = mode;
            const modeTitle = document.getElementById('modeTitle');
            const modeInstruction = document.getElementById('modeInstruction');
            
            switch(mode) {
                case 'writing':
                    modeTitle.textContent = 'Writing Mode';
                    modeInstruction.innerHTML = 'âœï¸ Choose a number range and write the ordinal numbers in English!<br>Examples: 1st â†’ first, 2nd â†’ second, 3rd â†’ third, 4th â†’ fourth';
                    break;
                case 'speaking':
                    modeTitle.textContent = 'Speaking Mode';
                    modeInstruction.innerHTML = 'ğŸ—£ï¸ Choose a number range and speak the ordinal numbers aloud!';
                    break;
                case 'listening':
                    modeTitle.textContent = 'Listening Mode';
                    modeInstruction.innerHTML = 'ğŸ‘‚ Choose a number range and listen to the ordinal numbers!';
                    break;
            }
            
            showScreen('difficultyScreen');
        }

        function setupGameMode() {
            const writingControls = document.getElementById('writingControls');
            const speakingControls = document.getElementById('speakingControls');
            const listeningControls = document.getElementById('listeningControls');
            const numberDisplay = document.getElementById('numberDisplay');
            const gameInstruction = document.getElementById('gameInstruction');
            const checkBtn = document.getElementById('checkBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            // Hide all controls first
            writingControls.style.display = 'none';
            speakingControls.style.display = 'none';
            listeningControls.style.display = 'none';
            
            switch(gameMode) {
                case 'writing':
                    writingControls.style.display = 'block';
                    numberDisplay.style.display = 'block';
                    gameInstruction.innerHTML = 'Write the ordinal number below in English and press Enter.<br><small style="opacity: 0.8;">Keep trying until you get it right!</small>';
                    checkBtn.style.display = 'inline-block';
                    nextBtn.style.display = 'none';
                    break;
                    
                case 'speaking':
                    speakingControls.style.display = 'block';
                    numberDisplay.style.display = 'block';
                    gameInstruction.innerHTML = 'Say the ordinal number shown below aloud.<br><small style="opacity: 0.8;">Click the microphone and speak clearly!</small>';
                    checkBtn.style.display = 'none';
                    nextBtn.style.display = 'inline-block';
                    setupSpeechRecognition();
                    break;
                    
                case 'listening':
                    listeningControls.style.display = 'block';
                    numberDisplay.style.display = 'none';
                    gameInstruction.innerHTML = 'Listen to the ordinal number and write what you hear.<br><small style="opacity: 0.8;">Click play to hear the number!</small>';
                    checkBtn.style.display = 'inline-block';
                    nextBtn.style.display = 'none';
                    break;
            }
        }

        function setupSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onresult = function(event) {
                    const spoken = event.results[0][0].transcript.toLowerCase().trim();
                    checkSpokenAnswer(spoken);
                };
                
                recognition.onerror = function(event) {
                    document.getElementById('feedback').textContent = 'Speech recognition error. Please try again.';
                    document.getElementById('feedback').className = 'feedback incorrect';
                    document.getElementById('startSpeaking').classList.remove('recording');
                };
                
                recognition.onend = function() {
                    document.getElementById('startSpeaking').classList.remove('recording');
                };
            }
        }

        function startSpeechRecognition() {
            if (recognition) {
                document.getElementById('startSpeaking').classList.add('recording');
                recognition.start();
            } else {
                alert('Speech recognition is not supported in your browser.');
            }
        }

        function playNumberAudio() {
            if (speechSynthesis) {
                const utterance = new SpeechSynthesisUtterance(currentAnswer);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                speechSynthesis.speak(utterance);
            } else {
                alert('Speech synthesis is not supported in your browser.');
            }
        }

        function checkSpokenAnswer(spoken) {
            const normalizedSpoken = normalizeAnswer(spoken);
            const normalizedCorrect = normalizeAnswer(currentAnswer);
            
            // Create accepted answers variants
            const acceptedAnswers = [normalizedCorrect];
            const oneVariant = normalizedCorrect
                .replace(/\ba hundredth\b/g, 'one hundredth')
                .replace(/\ba thousandth\b/g, 'one thousandth')
                .replace(/\ba millionth\b/g, 'one millionth')
                .replace(/\ba hundred and\b/g, 'one hundred and')
                .replace(/\ba thousand\b/g, 'one thousand')
                .replace(/\ba million\b/g, 'one million');
            
            if (oneVariant !== normalizedCorrect) {
                acceptedAnswers.push(oneVariant);
            }
            
            // Also accept the numeric ordinal form (e.g., "14th" for "fourteenth")
            const numericOrdinal = numberToOrdinalSuffix(currentNumber);
            acceptedAnswers.push(numericOrdinal.toLowerCase());
            
            const feedbackElement = document.getElementById('feedback');
            
            if (acceptedAnswers.includes(normalizedSpoken) || spoken.trim().toLowerCase() === numericOrdinal.toLowerCase()) {
                correctCount++;
                totalCount++;
                feedbackElement.textContent = 'âœ“ Correct! Well done!';
                feedbackElement.className = 'feedback correct';
                updateScores();
                
                // Auto-advance to next number after showing feedback
                setTimeout(() => {
                    generateNewNumber();
                }, 1000);
            } else {
                incorrectCount++;
                totalCount++;
                const correctDisplay = acceptedAnswers.length > 1 
                    ? `"${acceptedAnswers[0]}" or "${acceptedAnswers[1]}" or "${numericOrdinal}"` 
                    : `"${acceptedAnswers[0]}" or "${numericOrdinal}"`;
                feedbackElement.textContent = `âœ— You said: "${spoken}". Correct: ${correctDisplay}`;
                feedbackElement.className = 'feedback incorrect';
                updateScores();
            }
        }

        function backToStart() {
            showScreen('startScreen');
        }

        function backToDifficulty() {
            showScreen('difficultyScreen');
        }

        function backToMainMenu() {
            window.location.href = '../../index.html';
        }
    </script>
</body>
</html>